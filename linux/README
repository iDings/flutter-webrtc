TODO:duplicate some code with common/cpp, make some code really common
